{% extends 'chat/base.html' %}

{% block title %}{{ room.name }} - Django Chat{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto">
    <!-- Header da Sala -->
    <div class="bg-white rounded-t-xl shadow-lg p-6 mb-0">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full p-3">
                    <svg class="h-8 w-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">{{ room.name }}</h1>
                    {% if room.description %}
                    <p class="text-gray-600 text-sm">{{ room.description }}</p>
                    {% endif %}
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div id="connection-status" class="flex items-center bg-yellow-100 px-4 py-2 rounded-full">
                    <span class="h-2 w-2 bg-yellow-500 rounded-full mr-2"></span>
                    <span class="text-sm font-medium text-yellow-800">Conectando...</span>
                </div>
                <a href="{% url 'chat:leave_room' %}"
                    class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center">
                    <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Sair da Sala
                </a>
            </div>
        </div>
    </div>

    <!-- Área de Mensagens -->
    <div class="bg-gray-50 p-6 shadow-lg overflow-hidden" style="height: 500px;">
        <div id="chat-messages" class="h-full overflow-y-auto space-y-4 pr-4 scroll-smooth">
            <!-- Histórico de mensagens -->
            {% for message in messages %}
            <div class="flex {% if message.user.username == username %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-xs lg:max-w-md">
                    <div class="flex items-center mb-1 {% if message.user.username == username %}justify-end{% endif %}">
                        <span class="text-xs font-semibold text-gray-600">{{ message.user.username }}</span>
                        <span class="text-xs text-gray-400 ml-2">{{ message.timestamp|date:"H:i" }}</span>
                    </div>
                    <div
                        class="{% if message.user.username == username %}bg-indigo-600 text-white{% else %}bg-white text-gray-800{% endif %} rounded-lg px-4 py-2 shadow">
                        <p class="break-words">{{ message.content }}</p>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="h-full flex items-center justify-center">
                <div class="text-center text-gray-400">
                    <svg class="mx-auto h-16 w-16 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                    </svg>
                    <p>Nenhuma mensagem ainda. Seja o primeiro a enviar!</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Área de Input -->
    <div class="bg-white rounded-b-xl shadow-lg p-6">
        <form id="chat-form" class="flex space-x-4">
            <input type="text" id="chat-message-input" placeholder="Digite sua mensagem..." autocomplete="off"
                class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" />
            <button type="submit" id="chat-message-submit"
                class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition duration-200 flex items-center">
                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                </svg>
                Enviar
            </button>
        </form>
    </div>
</div>

<script>
    const roomId = '{{ room.id }}';
    const username = '{{ username }}';

    // Conecta ao WebSocket
    const chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomId + '/'
    );

    // Elementos DOM
    const chatMessages = document.querySelector('#chat-messages');
    const messageInput = document.querySelector('#chat-message-input');
    const messageForm = document.querySelector('#chat-form');
    const connectionStatus = document.querySelector('#connection-status');

    // Atualiza status de conexão
    function updateConnectionStatus(isConnected) {
        if (isConnected) {
            connectionStatus.className = 'flex items-center bg-green-100 px-4 py-2 rounded-full';
            connectionStatus.innerHTML = `
                <span class="h-2 w-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                <span class="text-sm font-medium text-green-800">Online</span>
            `;
        } else {
            connectionStatus.className = 'flex items-center bg-red-100 px-4 py-2 rounded-full';
            connectionStatus.innerHTML = `
                <span class="h-2 w-2 bg-red-500 rounded-full mr-2"></span>
                <span class="text-sm font-medium text-red-800">Desconectado</span>
            `;
        }
    }

    // Adiciona mensagem ao chat
    function addMessage(data) {
        const isOwnMessage = data.username === username;
        const messageTime = new Date(data.timestamp).toLocaleTimeString('pt-BR', {
            hour: '2-digit',
            minute: '2-digit'
        });

        // Remove mensagem de "nenhuma mensagem" se existir
        const emptyMessage = chatMessages.querySelector('.text-center.text-gray-400');
        if (emptyMessage) {
            emptyMessage.parentElement.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `flex ${isOwnMessage ? 'justify-end' : 'justify-start'}`;
        messageDiv.innerHTML = `
            <div class="max-w-xs lg:max-w-md">
                <div class="flex items-center mb-1 ${isOwnMessage ? 'justify-end' : ''}">
                    <span class="text-xs font-semibold text-gray-600">${data.username}</span>
                    <span class="text-xs text-gray-400 ml-2">${messageTime}</span>
                </div>
                <div class="${isOwnMessage ? 'bg-indigo-600 text-white' : 'bg-white text-gray-800'} rounded-lg px-4 py-2 shadow">
                    <p class="break-words">${data.message}</p>
                </div>
            </div>
        `;

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // WebSocket conectado
    chatSocket.onopen = function (e) {
        console.log('WebSocket conectado');
        updateConnectionStatus(true);

        // Auto-scroll para o final ao conectar
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // WebSocket desconectado
    chatSocket.onclose = function (e) {
        console.log('WebSocket desconectado');
        updateConnectionStatus(false);
    };

    // Recebe mensagem do WebSocket
    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        addMessage(data);
    };

    // Erro no WebSocket
    chatSocket.onerror = function (e) {
        console.error('WebSocket error:', e);
        updateConnectionStatus(false);
    };

    // Envia mensagem
    messageForm.onsubmit = function (e) {
        e.preventDefault();

        const message = messageInput.value.trim();

        if (message && chatSocket.readyState === WebSocket.OPEN) {
            chatSocket.send(JSON.stringify({
                'message': message
            }));

            messageInput.value = '';
            messageInput.focus();
        }
    };

    // Auto-scroll ao carregar
    window.addEventListener('load', function () {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    // Foca no input ao carregar
    messageInput.focus();
</script>
{% endblock %}